#!/bin/bash

# <!-- IGNORE: This line is intentional DO NOT MODIFY --><pre><script>document.querySelector('body').firstChild.textContent = '#!/bin/bash'</script>

# "Get Fleek Network" is an attempt to make our software more accessible.
# By providing scripts to automate the installation process of our software,
# we believe that it can help improve the onboarding experience of our users.
#
# Quick install: `curl https://get.fleek.network/install_ursa_proxy | bash`
#
# This script automates the setup process for ursa-proxy
# advanced users might find it better to compile and install it from source
# If that's your preference, go ahead and check our repo https://github.com/fleek-network/ursa
#
# For the users happy to have the script assist in the installation process of Fleek Network
# and the required dependencies, run the script at your own risk. 
#
# Contributing?
# - If you'd like to test changes locally use the env var `USE_BRANCH_NAME_FOR_GH_RAW`, for remote locales pulls
#
# Found an issue? Please report it here: https://github.com/fleek-network/get.fleek.network

# ðŸš‘ Check if running in Bash and supported version
[ "$BASH" ] || { printf >&2 'ðŸ™ Run the script with Bash, please!\n'; exit 1; }
(( BASH_VERSINFO[0] > 4 || BASH_VERSINFO[0] == 4 && BASH_VERSINFO[1] >= 2 )) || { printf >&2 'ðŸ™ Bash 4.2 or newer is required!\n'; exit 1; }

if [[ ! $PATH =~ .cargo/bin ]]; then
  echo "âš ï¸ Warning! Your Rust setup is missing an important step. Add the ~/.cargo/bin to the operating system PATH, otherwise you'll not be able to execute Rust binaries globally, e.g. ursa-proxy."

  exit 1
fi

hasCommand() {
  command -v "$1" >/dev/null 2>&1
}

identifyOS() {
  unameOut="$(uname -s)"

  case "${unameOut}" in
      Linux*)     os=Linux;;
      Darwin*)    os=Mac;;
      CYGWIN*)    os=Cygwin;;
      MINGW*)     os=MinGw;;
      *)          os="UNKNOWN:${unameOut}"
  esac

  echo "$os" | tr '[:upper:]' '[:lower:]'
}

identifyDistro() {
  if [[ -f /etc/os-release ]]; then
    source /etc/os-release
    echo "$ID"

    exit 0
  fi
  
  uname
}

isOSSupported() {
  os=$(identifyOS)

  if [[ "$os" == "linux" ]]; then
    distro=$(identifyDistro)

    if [[ "$distro" == "ubuntu" ]]; then
      currVersion=$(lsb_release -r -s | tr -d '.')

      if [[ "$currVersion" -lt "2204" ]]; then
        echo
        echo "ðŸ‘¹ Oops! You'll need Ubuntu 22.04 at least"
        echo

        exit 1
      fi
    elif [[ "$distro" == "debian" ]]; then
      currVersion=$(lsb_release -r -s | tr -d '.')

      if [[ "$currVersion" -lt "11" ]]; then
        echo
        echo "ðŸ‘¹ Oops! You'll need Debian 11 at least"
        echo

        exit 1
      fi
    else
      printf "ðŸ‘¹ Oops! Your operating system (%) distro (%s) is not supported by the ursa-proxy installer at this time.\n" "$os" "$distro"

      exit 1    
    fi

    echo "âœ… Operating system ($os), distro ($distro) is supported!"
  else
    printf "ðŸ‘¹ Oops! Your operating system (%) is not supported by the ursa-proxy installer at this time.\n" "$os"

    exit 1
  fi
}

introAscii() {
cat << "URSA_START_SCRIPT"

          |
          |   .
   `.  *  |     .'
     `. ._|_* .'  .
   . * .'   `.  *
-------|     |-------
   .  *`.___.' *  .
      .'  |* `.  *
    .' *  |  . `.
        . |
          |
URSA_START_SCRIPT

echo
echo "â­ï¸ Ursa-proxy, for the Decentralized Content Delivery Network (DCDN) â­ï¸"
echo
echo "â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜… ðŸŒ Website https://fleek.network"
echo "â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜… ðŸ“š Documentation https://docs.fleek.network"
echo "â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜… ðŸ’¾ Git repository https://github.com/fleek-network/ursa"
echo "â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜… ðŸ¤– Discord https://discord.gg/fleekxyz"
echo "â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜… ðŸ¤ Twitter https://twitter.com/fleek_net"
echo "â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜… ðŸŽ¨ Ascii art by https://www.asciiart.eu"
echo
}

if [[ -z ${SKIP_INTRO+x} ]]; then
  introAscii
fi

printf "ðŸ¤– Check if operating system is supported\n"
isOSSupported
echo

(
  exec < /dev/tty;

  # Defaults
  defaultUrsaPath="$HOME/fleek-network/ursa"
  defaultUrsaProxyLogPath="/var/log/ursa-proxy"
  defaultUrsaProxyDiagnosticFilename="diagnostic.log"
  defaultUrsaProxyOutputFilename="output.log"
  defaultUrsaProxySystemdServiceName="ursa-proxy"
  defaultUrsaProxySystemdServicePath="/etc/systemd/system/$defaultUrsaProxySystemdServiceName.service"
  defaultExecCargoProxyCmd="ursa-proxy daemon"
  # TODO: Disabled as ursa-proxy has no output at time of writing
  defaultUrsaProxyDiagnosticLogAbsPath="$defaultUrsaProxyLogPath/$defaultUrsaProxyDiagnosticFilename"
  defaultUrsaProxyOutputLogAbsPath="$defaultUrsaProxyLogPath/$defaultUrsaProxyOutputFilename"

  # User data
  selectedUrsaPath=""

  if [[ -f "$defaultUrsaProxySystemdServicePath" ]]; then
    # Obs: the extra white space between âš ï¸ and warning is for alignment
    while read -rp "âš ï¸  Warning! A service of name ursa-proxy has been found at $defaultUrsaProxySystemdServicePath, the ursa-proxy installer script may override any custom settings if you proceed. Would you like to ignore this warning and proceed? (yes/no)" answer; do
      if [[ $answer == [nN] || $answer == [nN][oO] ]]; then
        echo "ðŸ¦– The ursa-proxy install and setup script has terminated."

        exit 1
      elif [[ $answer == [yY] || $answer == [yY][eE][sS] ]]; then
        break;
      fi
    done
  fi

  if [[ -n "$SELECTED_URSA_PATH" ]]; then
    selectedUrsaPath="$SELECTED_URSA_PATH"
  else
    while read -rp "ðŸ™‹â€â™€ï¸ Is the Ursa repository source-code in the default path $defaultUrsaPath? Type \"no\" to change the location (yes/no) " answer; do
      if [[ $answer == [nN] || $answer == [nN][oO] ]]; then
        while read -rp "ðŸ™‹â€â™€ï¸ What's the location where the Ursa repository is?" answer; do
          if [[ -d "$answer" ]]; then
            selectedUrsaPath="$answer"
            
            break
          fi

          echo "ðŸ’© Uh oh! The path ($answer) doesn't exist, let's try that again..."
        done
      elif [[ $answer == [yY] || $answer == [yY][eE][sS] ]]; then
        selectedUrsaPath="$defaultUrsaPath"

        break;
      fi
    done
  fi

  echo "ðŸ¤– Change work directory to $selectedUrsaPath"
  if ! cd "$selectedUrsaPath"; then
    echo "ðŸ‘¹ Oops! Failed to change work directory to \"$selectedUrsaPath\" for some reason..."
    echo

    exit 1
  fi

  echo

  if [[ ! -d ./crates/ursa-proxy ]]; then
    echo "ðŸ‘¹ Oops! The ursa-proxy crate was not found."

    exit 1
  fi

  echo "ðŸ¤– Build the ursa-proxy"
  if ! cargo install --path crates/ursa-proxy; then
    echo "ðŸ‘¹ Oops! Failed to build and install the ursa-proxy from source."

    exit 1
  fi

  if ! ln -s "$HOME/.cargo/bin/ursa-proxy" /usr/local/bin/ursa-proxy; then
    printf "ðŸ’© Uh oh! Failed to symlink %s to /usr/local/bin/ursa-proxy\n" "$HOME/.cargo/bin/ursa-proxy"
  fi

  echo

  if ! hasCommand ursa-proxy; then
    echo "ðŸ‘¹ Oops! The ursa-proxy binary was not found for some reason."

    exit 1
  fi

  printf "ðŸ¤– Declare the service and store in the system path\n"
# Here "no identation" is intentional, do not change
cat << URSA_PROXY_SERVICE > "$defaultUrsaProxySystemdServicePath"
[Unit]
Description=Ursa-proxy, for the Decentralized Content Delivery Network (DCDN)

[Service]
Type=simple
MemoryHigh=1G
RestartSec=15s
Restart=always
ExecStart=$defaultExecCargoProxyCmd
StandardOutput=append:$defaultUrsaProxyOutputLogAbsPath
StandardError=append:$defaultUrsaProxyDiagnosticLogAbsPath

[Install]
WantedBy=multi-user.target
URSA_PROXY_SERVICE

  printf "ðŸ¤– Set service file permissions\n"
  if ! sudo chmod 644 "$defaultUrsaProxySystemdServicePath"; then
    echo "ðŸ’© Uh oh! Failed to update the file permissions for $defaultUrsaProxySystemdServicePath"
  else
    echo "âœ… Updated the ursa-proxy service file permissions"
  fi

  echo

  printf "ðŸ¤– Create logs directory"
  if ! sudo mkdir -p "$defaultUrsaProxyLogPath"; then
    read -rp "ðŸ’© Uh oh! Failed to create the directory $defaultUrsaProxyLogPath for the logs, you might want to troubleshoot this issue. Press ENTER to continue..."
  else
    echo "âœ… Created the logs directory $defaultUrsaProxyLogPath"
  fi

  for file in "$defaultUrsaProxyDiagnosticLogAbsPath" "$defaultUrsaProxyOutputLogAbsPath"; do
    if ! sudo touch "$file"; then
      echo "ðŸ’© Uh oh! Failed to create $file"
    else
      echo "âœ… Created the log file $file"
    fi
  done

  if ! sudo chmod -R 644 "$defaultUrsaProxyLogPath"; then
    read -rp "ðŸ’© Uh oh! Failed to chmod the directory $defaultUrsaProxyLogPath for the logs, you might want to troubleshoot this issue. Press ENTER to continue..."
  else
    echo "âœ… Set permissions for $defaultUrsaProxyLogPath"
  fi
 
  printf "ðŸ¤– System control daemon reload\n"
  if ! sudo systemctl daemon-reload; then
    echo "ðŸ’© Uh oh! The systemctl daemon reload failed"
  else
    echo "âœ… The systemctl daemon reload was successful!"
  fi

  echo

  printf "ðŸ¤– Start the ursa-proxy service\n"
  if ! sudo systemctl start "$defaultUrsaProxySystemdServiceName"; then
    echo "ðŸ’© Uh oh! Failed to start the ursa-proxy service"
  else
    echo "âœ… Started the ursa-proxy service"
  fi

  echo

  printf "ðŸ¤– Enable the ursa-proxy service on startup when the system boots\n"
  if ! sudo systemctl enable "$defaultUrsaProxySystemdServiceName"; then
    echo "ðŸ’© Uh oh! Failed to enable the ursa-proxy on system startup"
  else
    echo "âœ… Enabled the ursa-proxy on system startup"
  fi

  echo
  echo "ðŸŒˆ The Ursa proxy server is running!"
  echo
  # TODO: At time of writing the ursa-proxy does not have output
  # for this reason the StandardOutput and Error is set to null otherwise it'd exit 209
  # so, enable the StandardOutput and Error afterwards
  # echo "You can watch the ursa-proxy output by running the command:"
  # echo "tail -f $defaultUrsaOutputLogAbsPath"
  # echo
  # echo "For diagnostics run the command:"
  # echo "tail -f $defaultUrsaDiagnosticLogAbsPath"
  echo
  echo "Launch or stop the ursa-proxy by running:"
  echo "sudo systemctl stop ursa-proxy"
  echo "sudo systemctl restart ursa-proxy"
  echo
  echo "Check the status of the service:"
  echo "sudo systemctl status ursa-proxy"
  echo
  echo "Learn more by checking our guides at https://docs.fleek.network"
  echo "âœ¨ That's all!"
  echo
)