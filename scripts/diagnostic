#!/bin/bash

# "Get Fleek Network" is an attempt to make our software more accessible.
# By providing scripts to automate the installation process of our software,
# we believe that it can help improve the onboarding experience of our users.
#
# Quick diagnostic: `curl https://get.fleek.network/diagnostic | bash`
#
# This scripts automates the process of getting detailed information about the server where Ursa is running
# such as, file permissions, systemd services, user, paths, etc.
#
# Found an issue? Please report it here: https://github.com/fleek-network/get.fleek.network

# üöë Check if running in Bash and supported version
[ "$BASH" ] || { printf >&2 'üôè Run the script with Bash, please!\n'; exit 1; }
(( BASH_VERSINFO[0] > 4 || BASH_VERSINFO[0] == 4 && BASH_VERSINFO[1] >= 2 )) || { printf >&2 'üôè Bash 4.2 or newer is required!\n'; exit 1; }

#defaults
nginxConfigPath="$HOME/fleek-network/ursa/docker/full-node/data/nginx"
diagnosticFilename="diagnostic.log"
defaultFleekNetworkInstallPath="$HOME/fleek-network/ursa"
dotUrsaPath="$HOME/.ursa/config.toml"
dotUrsaProxyPath="$HOME/.ursa/proxy/config.toml"
defaultUrsaBinPath="/usr/bin/ursa"
pasteCliUrl="https://0x0.st"
separator="----------"

# User data
selectedUrsaPath=""

#¬†styles
bold=$(tput bold)
normal=$(tput sgr0)

# Service ports
declare -a fleekNetworkServicePorts=(80 443 4069 6009)

tempWorkDir=$(mktemp -d)

onInterruption() {
  rm -rf "$tempWorkDir"
}

trap onInterruption INT

if ! cd "$tempWorkDir"; then
  echo "üëπ Oops! Failed to create temporary directory to store diagnostic logs"

  exit 1
fi

validateIpAddress() {
  local validate="^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$"

  [[ "$1" =~ $validate ]] && ping -c1 -W1 "$1" > /dev/null
}

getIpAddress() {
  detectedIpAddress=$(curl -s ifconfig.me)

  if validateIpAddress "$detectedIpAddress"; then
    echo "$detectedIpAddress"

    return
  fi

  detectedIpAddress=$(curl -s icanhazip.com)

  if validateIpAddress "$detectedIpAddress"; then
    echo "$detectedIpAddress"

    return
  fi

  detectedIpAddress=$(curl -s ident.me)

  if validateIpAddress "$detectedIpAddress"; then
    echo "$detectedIpAddress"

    return
  fi

  echo "ERROR_IP_ADDRESS_NOT_AVAILABLE"
}

cat << "EOF"

                  .eeeeeeeee
                  .$$$$$$$$P"
                .$$$$$$$$P
                z$$$$$$$$P
              z$$$$$$$$"
              z$$$$$$$$"
            d$$$$$$$$"
            d$$$$$$$$"
          .d$$$$$$$P
        .$$$$$$$$P
        .$$$$$$$$$.........
      .$$$$$$$$$$$$$$$$$$"
      z$$$$$$$$$$$$$$$$$P"
    -**********$$$$$$$P
              d$$$$$$"
            .d$$$$$$"
            .$$$$$$P"
          z$$$$$$P
          d$$$$$$"
        .d$$$$$$"
      .$$$$$$$"
      z$$$$$$$beeeeee
    d$$$$$$$$$$$$$*
    ^""""""""$$$$$"
            d$$$*
          d$$$"
          d$$*
        d$P"
      .$$"
      .$P"
    .$"
    .P"
  ."
  /"

EOF

echo
echo "‚ö°Ô∏è Ursa spaceship diagnostics ‚ö°Ô∏è"
echo
echo "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ üåç Website https://fleek.network"
echo "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ üìö Documentation https://docs.fleek.network"
echo "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ üíæ Git repository https://github.com/fleek-network/ursa"
echo "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ü§ñ Discord https://discord.gg/fleekxyz"
echo "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ üê§ Twitter https://twitter.com/fleek_net"
echo "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ üé® Ascii art by https://www.asciiart.eu"
echo

echo "üôã‚Äç‚ôÄÔ∏è We're going save the diagnostic details to https://0x0.st. When complete copy and share the diagnostics URL to us in our Discord channel!"
echo

(
  exec < /dev/tty;

  while read -rp "üôã‚Äç‚ôÄÔ∏è Is the Ursa repository source-code in the default path $defaultFleekNetworkInstallPath? (yes/no) " answer; do
    if [[ $answer == [nN] || $answer == [nN][oO] ]]; then
      while read -rp "üôã‚Äç‚ôÄÔ∏è What's the location where the Ursa repository is? " answer; do
        if [[ -d "$answer" ]]; then
          selectedUrsaPath="$answer"
          
          break 2
        fi

        echo "üí© Uh oh! The path ($answer) doesn't exist, let's try that again..."
      done
    elif [[ $answer == [yY] || $answer == [yY][eE][sS] ]]; then
      selectedUrsaPath="$defaultFleekNetworkInstallPath"

      break;
    fi
  done

  echo "üôè Be patient while we generate the URL for you, please!"
  echo

  echo "ü§ñ Display Linux distro version"
  echo

  cat /etc/*-release
  echo

  echo "ü§ñ The /proc/version"
  cat /proc/version

  echo "ü§ñ CPU details"
  cat /proc/cpuinfo

  echo "ü§ñ Memory info"
  mem=$(awk '/^MemTotal:/{print $2}' /proc/meminfo);
  partDiskSpace=$(df --output=avail -B 1 "$PWD" |tail -n 1)
  echo "Total memory $mem"
  echo "Disk space $partDiskSpace"

  echo "ü§ñ User home"
  echo "$HOME"
  echo

  echo "üí° The current user details"
  id
  echo

  echo "User name is $USER"
  echo

  echo "ü§ñ System PATH"
  echo "$PATH"
  echo

  echo "ü§ñ User IP Address"
  getIpAddress

  echo "ü§ñ Ports"
  hasPortsAvailable=0
  for port in "${fleekNetworkServicePorts[@]}"; do
    if lsof -i :"$port" >/dev/null; then
      echo "The port $port which is required but is in use"
      echo "$separator Start details for port $port $separator"
      lsof -i :"$port"
      echo "$separator End details for port $port $separator"
      echo

      hasPortsAvailable=1
    fi
  done

  echo

  if [[ "$hasPortsAvailable" -eq 1 ]]; then
    echo "üëπ Required port(s) are in use."
    echo
  fi

  echo

  echo "ü§ñ Iptables list of rules"
  iptables -S
  echo

  if command -v "ufw" >/dev/null 2>&1; then
    echo "‚úÖ ufw found!"

    echo "ü§ñ UFW Status"
    ufw status
  fi

  echo

  echo "ü§ñ Is the Ursa source-code installed in user home?"
  echo

  if [[ ! -d "$HOME/fleek-network/ursa" ]]; then
    echo "üí© Uh-oh! The Ursa source-code is not installed in the user HOME path $HOME"
    echo

    echo "ü§ñ Is the Ursa source-code installed in root home?"
    echo
    
    if [[ ! -d "/root/fleek-network/ursa" ]]; then
      echo "üí© Uh-oh! The Ursa source-code is not installed in the root HOME path /root/fleek-network/ursa"
      echo
    else
      echo "‚úÖ Found the Ursa source stored in /root/fleek-network/ursa"
      echo
    fi
  else
    echo "‚úÖ Found the Ursa source stored in $HOME/fleek-network/ursa"
    echo
  fi

  echo "ü§ñ File permissions"
  echo
  ls -la "$selectedUrsaPath"
  echo

  if [[ -d $selectedUrsaPath ]]; then
    echo "ü§ñ The docker-compose.yml content"
    cat "$selectedUrsaPath/docker/full-node/docker-compose.yml"
  fi

  echo "ü§ñ Check Docker"
  echo

  if command -v "docker" >/dev/null 2>&1; then
    echo "‚úÖ Docker is installed!"
    echo

    echo "Docker path"
    dockerPath=$(which docker)
    echo

    echo "$dockerPath"
    echo

    echo "Docker permissions"
    ls -la "$dockerPath"
    echo

    echo "Docker version"
    docker -v
    echo

    echo "Docker compose version"
    docker compose version

    echo "Docker-compose is installed?"
    which docker-compose

    echo "Docker systemd status"
    systemctl status --no-pager docker
    echo

    echo "Docker process status"
    docker ps -a
    echo

    echo "Is Docker container full-node_ursa_1 running?"
    if ! docker container inspect -f '{{.State.Running}}' full-node-ursa-1; then
      echo "ü§ñ Will check alternative name full-node_ursa_1"
      echo
      docker container inspect -f '{{.State.Running}}' full-node_ursa_1
    fi
    echo

    echo "ü§ñ NGINX Config files"
    echo

    showNginxConfigContent() {
      if [[ -f "$nginxConfigPath/$1" ]]; then
        cat "$nginxConfigPath/$1"

        return 0
      fi
      
      echo "üí© Uh-oh! NGINX Https config not found at $nginxConfigPath/$1"
      echo
    }

    for conf in "http.conf" "https.conf"; do
      showNginxConfigContent "$conf"
    done
  fi

  echo "ü§ñ Dot Ursa"
  echo

  if [[ -d $HOME/.ursa ]]; then
    echo "‚úÖ Found dot ursa at $HOME/.ursa"
    echo

    echo "ü§ñ Dot Ursa Config.toml"
    echo

    cat "$dotUrsaPath"
    echo

    echo "ü§ñ Dot Ursa file permissions"
    ls -la "$dotUrsaPath"
    echo
  else
    echo "üí© Uh-oh! The dot Ursa was not found"
    echo
  fi

  if [[ -d $HOME/.ursa/proxy ]]; then
    echo "‚úÖ Found dot ursa, ursa-proxy at $HOME/.ursa/proxy"
    echo

    echo "ü§ñ The ursa proxy config content"
    cat "$dotUrsaProxyPath"
  else
    echo "üí© Uh-oh! The dot Ursa, ursa-proxy was not found"
    echo
  fi

  if command -v "ursa" >/dev/null 2>&1; then
    echo "‚úÖ Ursa binary globally accessible"
    echo

    if [[ -f "$defaultUrsaBinPath" ]]; then
      echo "‚úÖ Ursa binary in $defaultUrsaBinPath"
      echo
    else
      echo "üí© Ursa binary not found at $defaultUrsaBinPath";
      echo
    fi

    echo

    if [[ :$PATH: = *:"$defaultUrsaBinPath":* ]]; then
      echo "‚úÖ Ursa $defaultUrsaBinPath in system PATH";
      echo
    else
      echo "üí© Ursa $defaultUrsaBinPath not found in system PATH";
      echo
    fi

    echo

    echo "ü§ñ Ursa binary file permissions"
    ls -la "$defaultUrsaBinPath"
    echo

    if ! docker ps -a | grep -q ursa; then
      echo "ü§ñ NGINX Service status"
      echo
      
      systemctl status --no-pager nginx
      echo
    fi
  fi

  if [[ -d $HOME/.ursa/proxy ]]; then
    echo "‚úÖ Found dot ursa, ursa-proxy at $HOME/.ursa/proxy"
    echo

    echo "ü§ñ The ursa proxy config content"
    cat "$dotUrsaProxyPath"

    if command -v "ursa-proxy" >/dev/null 2>&1; then
      echo "‚úÖ Ursa-proxy binary globally accessible"

      echo "ü§ñ Systemd ursa-proxy service"
      if ! systemctl status ursa-proxy; then
        echo "üí© Uh oh! There's no systemd ursa-proxy service"
      fi
    fi
  else
    echo "üí© Uh-oh! The dot Ursa, ursa-proxy was not found"
    echo
  fi  
) > "$diagnosticFilename"

pasteUrl=$(curl -sF "file=@$diagnosticFilename" $pasteCliUrl)

if [[ ! $pasteUrl = $pasteCliUrl*  ]]; then
  echo "üëπ Oops! We failed to create the diagnostic URL for some reason, try again later?" >&2

  exit 1
fi

echo "‚úÖ Diagnostic is available at ${bold}$pasteUrl${normal}"
echo "Copy and share the diagnostic URL $pasteUrl to our Discord channel üôè"
echo