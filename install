#!/bin/bash

# <!-- IGNORE: This line is intentional DO NOT MODIFY --><pre><script>document.querySelector('body').firstChild.textContent = '#!/bin/bash'</script>

# "Get Fleek Network" is an attempt to make our software more accessible.
# By providing scripts to automate the installation process of our software,
# we believe that it can help improve the onboarding experience of our users.
#
# Quick install: `curl https://get.fleek.network | bash`
#
# This script automates the process illustrated in our install documentation and guides,
# advanced users might find it better to follow the instructions in the documentation site.
# If that's your preference, go ahead and check our guides https://docs.fleek.network
#
# Contributing?
# - If you'd like to test changes locally based on a Lightning repo branch use the env var `USE_LIGHTNING_BRANCH`
# - If you'd like to test changes locally based on a get.fleek.network repo branch use the env var `USE_GET_BRANCH`
# E.g. curl https://raw.githubusercontent.com/fleek-network/get.fleek.network/feat/foobar-foo-bar/install | USE_GET_BRANCH="feat/foobar-foo-bar" bash
#
# Found an issue? Please report it here: https://github.com/fleek-network/get.fleek.network

# TODO: Switch to main on release
useBranch=${USE_LIGHTNING_BRANCH="testnet-alpha-1"}
useGetBranch=${USE_GET_BRANCH="main"}

# Workdir
if ! cd "$(mktemp -d)"; then
  echo "üëπ Oops! We tried to create a temporary directory to host some install artifacts but failed for some reason..."

  exit 1
fi

# Defaults
defaultTestInstallMagicWord=I_AM_FULLY_AWARE_AND_WANT_TO_PROCEED_TO_TEST_INSTALL_ONLY

# Utils
testnetPhaseFinishedWarning() {
  echo "‚ö†Ô∏è WARNING: The Testnet Phase {1} has ENDED on Thursday, Oct. 26th 2023! You'll HAVE TO WAIT for next Testnet Phase in order to run a node successfully. If you'd like TO PARTICIPATE on the next phase, keep track of our announcements by following us on Discord and Twitter to avoid disappointment!"
  echo
  echo "If you decide to set up a node for testing the INSTALL PROCESS ONLY, knowing that it'll fail to run successfully, you can do so by typing $defaultTestInstallMagicWord in the prompt."
  echo

  while read -rp "üôã‚Äç‚ôÄÔ∏è What do you have to type to proceed with the installation only? " answer; do
    if [[ "$answer" == "$defaultTestInstallMagicWord" ]]; then
      echo
      read -rp "‚ö†Ô∏è WARNING: The installer will now proceed. Remember that the node will NOT RUN SUCCESSFULLY as you have to wait for the new Testnet Phase announcement and rules. If you keep the setup, the future Testnet Phase will require you to update or troubleshoot it! Press ENTER to continue..."
      echo

      break;
    fi

    echo
    echo "üí© Uh-oh! Seems that you haven't read the warning message. Exited!"
    echo

    exit 1
  done
}

# The white space before and after is intentional
cat << "ART"

  ‚≠êÔ∏è Fleek Network Lightning CLI installer ‚≠êÔ∏è

              zeeeeee-
              z$$$$$$"
            d$$$$$$"
            d$$$$$P
          d$$$$$P
          $$$$$$"
        .$$$$$$"
      .$$$$$$"
      4$$$$$$$$$$$$$"
    z$$$$$$$$$$$$$"
    """""""3$$$$$"
          z$$$$P
          d$$$$"
        .$$$$$"
      z$$$$$"
      z$$$$P
    d$$$$$$$$$$"
    *******$$$"
        .$$$"
        .$$"
      4$P"
      z$"
    zP
    z"
  /

ART

(
  exec < /dev/tty;

  testnetPhaseFinishedWarning

  echo
  echo "Select how you'd like to run the Fleek Network:"
  echo
  echo "1) üî´ Natively (recommended)"
  echo "2) üëæ Docker Stack (unstable/experimental)"
  echo

  while read -rp "Type your selection number> " answer; do
    if [[ $answer -eq 1 ]]; then
      echo
      echo "Before we launch the process, just to let you know that the Lightning CLI will be compiled from the Rust ü¶Ä source code. Depending on your machine specifications this can be quite slow, be patient!"
      echo
      read -rp "Let's launch the process, press ENTER to continue..."

      curl -s "https://raw.githubusercontent.com/fleek-network/get.fleek.network/$useGetBranch/scripts/install_native" > install_native
      chmod +x install_native

      ./install_native

      break;
    elif [[ $answer -eq 2 ]]; then
      echo
      read -rp "We'll launch the process, press ENTER to continue..."

      curl -s "https://raw.githubusercontent.com/fleek-network/get.fleek.network/$useGetBranch/scripts/install_docker" > install_docker
      chmod +x install_docker

      ./install_docker

      break
    fi

    echo "üí© Uh oh! We're expecting a yes (Y) or a no (N) answer. Try again..."
  done
)