#!/bin/bash

# <!-- IGNORE: This line is intentional DO NOT MODIFY --><pre><script>document.querySelector('body').firstChild.textContent = '#!/bin/bash'</script>

# "Get Fleek Network" is an attempt to make our software more accessible.
# By providing scripts to automate the installation process of our software,
# we believe that it can help improve the onboarding experience of our users.
#
# Quick install: `curl https://get.fleek.network/install_native | bash`
#
# This script automates the process illustrated in our guide "how to install rust and the dependencies for ursa cli"
# advanced users might find it better to follow the instructions in the guide
# If that's your preference, go ahead and check our guides https://docs.fleek.network
#
# For the users happy to have the script assist in the installation process of Fleek Network
# and the required dependencies, run the script at your own risk. 
#
# Contributing?
# - If you'd like to test changes locally use the env var `USE_BRANCH_NAME_FOR_GH_RAW`, for remote locales pulls
#
# Found an issue? Please report it here: https://github.com/fleek-network/get.fleek.network

# ðŸš‘ Check if running in Bash and supported version
[ "$BASH" ] || { printf >&2 'ðŸ™ Run the script with Bash, please!\n'; exit 1; }
(( BASH_VERSINFO[0] > 4 || BASH_VERSINFO[0] == 4 && BASH_VERSINFO[1] >= 2 )) || { printf >&2 'ðŸ™ Bash 4.2 or newer is required!\n'; exit 1; }

# Defaults
defaultUrsaPath="$HOME/fleek-network/ursa"
defaultNginxSitesAvailablePath="/etc/nginx/sites-available"
defaultNginxSitesEnabledPath="/etc/nginx/sites-enabled"

# App state
selectedUrsaPath="$defaultUrsaPath"
selectedDomainName=""
selectedIpAddress=""

# Confirm validators
confirmDomainName() {
  local validate="^([a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]\.)+[a-zA-Z]{2,}$"

  if whois "$1" | grep -Ei '[Uu]nallocated|returned 0 objects' > /dev/null; then
    return 1
  fi

  [[ $1 =~ $validate ]]
}

confirmIpAddress() {
  local validate="^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$"

  [[ "$1" =~ $validate ]] && ping -c1 -W1 "$1" > /dev/null
}

confirmEmailAddress() {
  local validate="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]+$"

  [[ "$1" =~ $validate ]]
}

read -rp "ðŸ‘· This is in work-in-progress and currently only supporting Ubuntu\nPress ENTER to continue..."

if ! command -vp "cargo" &> /dev/null && ! command -vp "rustc" &> /dev/null; then
  printf "ðŸ¤– Install the Rustup tool\n"
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

  printf "ðŸ¤– Reload PATH environments to include Cargo\n"
  source "$HOME/.cargo/env"
  
  printf "âœ… Rust is installed!\n"

  printf "Cargo version is %s\n" "$(cargo --version)"
else
  printf "ðŸ¤– Install the Rustup tool\n"
  rustup update
fi

printf "ðŸ¤–%s\n" "Install Sccache is a ccache-like compiler caching tool"
cargo install sccache

printf "ðŸ¤–%s\n" "Update and upgrade apt-get"
sudo apt-get update -y
sudo apt-get upgrade -y

printf "ðŸ¤–%s\n" "Install the build-essentials packages, necessary for compiling general software and for our use-case Ursa CLI"
sudo apt-get install build-essential -y

printf "ðŸ¤–%s\n" "Install required to compile the application (cmake, clang, pkg-config and libssl-dev)"
sudo apt-get install cmake clang pkg-config libssl-dev -y

printf "ðŸ¤–%s\n" "Install the Protobufer Compiler"
sudo apt-get install protobuf-compiler -y

if ! hasCommand git &> /dev/null; then
  printf "ðŸ¤–%s\n" "Install Git"
  sudo apt-get install git -y
fi

printf -v prompt "ðŸ¤– The Ursa source-code is going to be git cloned to recommended path %s (otherwise, type \"n\" to modify path). Should proceed with installing to default path? (y/n)\n" "$defaultUrsaPath"
while read -r -p "$prompt"$'\n> ' answer; do
  if [[ "$answer" == [nN] ]]; then
    printf -v prompt "\nðŸ™‹â€â™€ï¸ What path should we clone the Ursa source-code to?"
    read -r -p "$prompt"$'\n> ' userPath

    if [[ -d "$userPath" ]]; then
      printf "ðŸ‘¹ Oops! The path %s already exists! Clear the path and try again...\n" "$userPath"

      exit 1
    fi

    if ! mkdir -p "$selectedUrsaPath"; then
      printf "ðŸ‘¹ Oops! Failed to create the path $userPath %s\n" "$userPath"

      exit 1
    fi

    selectedUrsaPath="$userPath"

    break
  fi

  if [[ "$answer" == [yY] ]]; then
    selectedUrsaPath="$defaultUrsaPath"
    
    break
  fi
done

printf "ðŸ¤– Clone the Ursa project to %s\n" "$selectedUrsaPath"
git clone https://github.com/fleek-network/ursa.git "$selectedUrsaPath"

printf "ðŸ¤–%s\n" "Change directory to ursa"
if ! cd "$selectedUrsaPath"; then
  printf "ðŸ‘¹ Oops! Failed to change directory to %s\n" "$selectedUrsaPath"

  exit 1
fi

if ! hasCommand make &> /dev/null; then
  printf "ðŸ¤–%s\n" "Install make"
  sudo apt-get install make -y
fi

printf "ðŸ¤–%s\n" "Build and install the Ursa CLI"

if ! make install; then
  printf "ðŸ‘¹ Oops! Failed to build and install the Ursa CLI. If you are experience issues, help us improve by letting us know in our Discord channel\n"

  exit 1
fi

printf "Great ðŸ‘Œ! You have successfully installed all the required packages, libraries and have compiled and installed Ursa\n"

printf "If you'd like to have the Ursa CLI command available globally, add the bin (%s) to your PATH e.g., edit your shell profile file, save and restart the current shell e.g., .bashrc, .zshrc, .profile to include export PATH=\"%s:\$PATH\"\n" "$selectedUrsaPath" "$selectedUrsaPath"

if ! hasCommand nginx &> /dev/null; then
  printf -v prompt "ðŸ¤– Nginx should be installed, would you like to proceed with the installation? (y/n)\n"
  while read -rp "$prompt"$'\n> ' answer; do
    if [[ "$answer" == [nN] ]]; then
      printf "ðŸ‘¹ Oops! The install process has terminated\n"

      exit 1
    fi

    if [[ "$answer" == [yY] ]]; then      
      break
    fi
  done

  printf "ðŸ¤– Install Nginx\n"
  sudo apt install nginx -y
fi

if hasCommand ufw &> /dev/null; then
  printf "ðŸ¤– HTTP and HTTPS will be set as allowed via your firewall ufw\n"
  sudo ufw allow 'Nginx HTTP'
  sudo ufw allow 'Nginx HTTPS'
else
  read -rp "ðŸš“ Make sure you don't have HTTP and HTTPS ports 80 and 443 blocked by a firewall\n"
fi

read -rp "A custom domain name is required to secure the communications with SSL/TLS.\nVisit your domain name registrar's dashboard, create a new domain, and update the A record to have the hostname answer with the server IP address\nMake sure you complete this step before proceeding, as we'll verify it!\nPress ENTER to continue..."

printf -v prompt "ðŸ¤– What's your domain name?\n"
while read -rp "$prompt"$'\n> ' answer; do
  if confirmDomainName "$answer"; then
    selectedDomainName="$answer"
    break
  fi

  printf "ðŸ’© The domain name provided is not valid!\n"
done

detectedIpAddress=$(curl --silent ifconfig.me || curl --silent icanhazip.com || echo "ERROR_IP_ADDRESS_NOT_AVAILABLE")

printf "The server IP address that the domain is pointing to is required. We've noticed that this machine public IP address is %s\n" "$detectedIpAddress"
printf -v prompt "ðŸ¤– Is the domain name pointing to the public IP address %s? (y/n)\n" "$detectedIpAddress"
while read -rp "$prompt"$'\n> ' answer; do
  if confirmIpAddress "$answer" && [[ "$answer" == [yY] ]]; then
    if ! dig "$selectedDomainName" +nostats +nocomments +nocmd | tr -d '\t' | grep "A$answer" >/dev/null 2>&1 ; then
      printf "ðŸ’© Oh no! The %s doesn't seem to point to the IP address %s\n" "$selectedDomainName" "$answer"

      continue
    fi

    selectedIpAddress="$answer"

    break
  fi

  printf "ðŸ’© Oh no! The IP address doesn't seem valid!\n"
done

echo "
  proxy_cache_path /cache keys_zone=nodecache:100m levels=1:2 inactive=31536000s max_size=10g use_temp_path=off;

  server {
      listen 80;
      listen [::]:80;
      server_name $selectedDomainName;

      location /.well-known/acme-challenge/ {
          root /var/www/certbot;
      }

      location /stub_status {
        stub_status;
      }

      proxy_redirect          off;
      client_max_body_size    10m;
      client_body_buffer_size 128k;
      proxy_connect_timeout   90;
      proxy_send_timeout      90;
      proxy_read_timeout      90;
      proxy_buffers           32 128k;

      location / {
        add_header content-type  application/vnd.ipld.raw;
        add_header content-type  application/vnd.ipld.car;
        add_header content-type  application/octet-stream;
        add_header cache-control public,max-age=31536000,immutable;

        proxy_cache nodecache;
        proxy_cache_valid 200 31536000s;
        add_header X-Proxy-Cache \$upstream_cache_status;
        proxy_cache_methods GET HEAD POST;
        proxy_cache_key \"\$request_uri|\$request_body\";
        client_max_body_size 1G;

        proxy_pass http://ursa:4069;
      }
  }
" > "$defaultNginxSitesAvailablePath/ursa-http.conf"